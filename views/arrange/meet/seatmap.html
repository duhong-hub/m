<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title></title>
	<link rel="stylesheet" href="../../../layuiadmin/layui/css/layui.css" media="all">
	<link rel="stylesheet" href="../../../web.contextmenu/web.contextmenu.css" media="all">
	<script src="../../../web.contextmenu/web.contextmenu.js"></script>
	<link rel="stylesheet" href="../../../css/seat.css" media="all">
	<script src="../../../js/jquery-3.1.1.min.js"></script>
	<link rel="stylesheet" href="rule_zq.css" />
	<style type="text/css">
		header {
			box-shadow: 0px 0px 5px gray;
			height: 3.5rem;
			position: fixed;
			left: 0px;
			top: 0px;
			width: 100%;
			z-index: 9999;
			background-color: white;
		}

		body {
			background-color: white;
		}

		/*右侧菜单*/
		.layui-right-nav {
			position: absolute;
			right: 20px;
			top: 0;
			height: 3.5rem;
			line-height: 3.5rem;
			background-color: #fff;
		}

		.layui-right-nav i {
			display: block;
			height: 20px;
			width: 20px;
			float: left;
			margin-top: 18px;
			padding-left: 7px;
			padding-right: 7px;
		}

		.layui-right-nav i img {
			width: 100%;
			display: block;
		}

		.btnbar-select{
			display: inline-block;
			width: 112px;
			float: right;
			margin-right: 400px;
			margin-top: 9px;
		}
	</style>
</head>

<body>
	<header>
		<span class="layui-breadcrumb" style="line-height: 3.5rem;">
			<a><cite> &nbsp; &nbsp; &nbsp; 座区图生成管理</cite></a>
			<a onclick="asd()"><cite><i class="layui-icon layui-icon-refresh-3" style="color: gray;"></i> &nbsp; 刷新
				</cite></a>
		</span>
		<!-- 右侧菜单 -->
		<div class="layui-form btnbar-select">
            <select class="dialogRuleSelect" id="ruleselect">
                <option value="1">按规则标色</option>
                <option value="2">按属性标色</option>
            </select>
		</div>
		<span class="layui-right-nav">
			<i id="nav-parallelism" data-type="parallelism" data="对应关系绑定"><img src="../../../images/parallelism.png"></i>
			<i id="nav-lock" data-type="bindLockSeats" data="锁定"><img src="../../../images/lock.png"></i>
			<i id="nav-radio" data-type="bindOneSeats" data="单选"><img src="../../../images/radio.png"></i>
			<i id="nav-selection" data-type="selectSeats" data="框选"><img src="../../../images/selection.png"></i>
			<i id="nav-drag" data-type="dragSeats" data="拖动"><img src="../../../images/drag.png"></i>
			<i id="rightbtn" data-type="bindContextMenu" data="右键"><img src="../../../images/rightbtn.png"></i>
			<i id="cancelrightbtn" data-type="removeContextMenu" data="取消右键"><img src="../../../images/cancelrightbtn.png"></i>
			<!-- <i id="nav-vacancy" data="空置"><img src="../../../images/vacancy.png"></i> -->
			<!-- <i id="nav-delete" data="删除"><img src="../../../images/delete.png"></i> -->
			<i id="nav-save" data="保存"><img src="../../../images/save.png"></i>
			<!-- <i id="nav-import" data-type="importData" data="导入座区数据"><img src="../../../images/import.png"></i> -->
			<i id="nav-createPdf" data="生成PDF座区图"><img src="../../../images/createPdf.png"></i>
			
			<!-- <i id="nav-rewrite" data="改写"><img src="../../../images/rewrite.png"></i> -->
			<i id="nav-print" data-type="print" data="设定打印区域"><img src="../../../images/print.png"></i>
			<i id="nav-close" data="关闭此窗口"  class="layui-ds" data-type="close" style="width: 18px;height: 18px;line-height: 3.5rem;"><img src="../../../images/close.png" ></i>
		</span>
		<!-- 右侧菜单 end-->
	</header>

</body>
<script src="../../../layuiadmin/layui/layui.js"></script>
<script src="../../../js/seatscontrol_drag.js"></script>
<script type="text/javascript">
	layui.config({
		base: '../../../layuiadmin/' //静态资源所在路径
	}).extend({
		index: 'lib/index' //主入口模块
	}).use(['index', 'user', 'table'], function () {
		var $ = layui.$,
			form = layui.form,
			element = layui.element,
			table = layui.table,
			layer = layui.layer,
			router = layui.router();
		/*右侧菜单HOVER显示提示文字*/
		$('.layui-right-nav i').each(function () {
			var _id = $(this).attr('id');
			var _data = $(this).attr('data');
			$("#" + _id).hover(function () {
				openMsg();
			}, function () {
				layer.close(subtips);
			});
			function openMsg() {
				subtips = layer.tips(_data, '#' + _id, { tips: [3, '#666'], time: 30000 });
			}
		});
		var url = 'https://f.longjuli.com';
		var uri = window.location.search;
		console.log(uri)
        var str = uri.substr(1);
        window.ruleid = str.substring(str.indexOf("=")+1,str.indexOf("&"));
		window.meetingid=str.substring(str.lastIndexOf("=")+1)
		window. roomid=str.substring(str.indexOf("&")+1,str.lastIndexOf("&"))
		window. newroomid=roomid.substring(roomid.indexOf("=")+1,roomid.length)
			   
		/*右侧菜单HOVER显示提示文字 end*/
		$.ajax({
			    url: url+"/roomtemplate/findByroomtemplate",
			    type: "get",
			    async: false,
			    xhrFields: {
			        withCredentials: true
			    },
			    data: {
			        "id": newroomid,
			       
			    },
			    success: function(data) {
			        var datas = data.data
			        console.log()
					$("body").append(data.data[0].templatecode);
					
					selectSeats();

					var condi = {
						"meeting_id": +meetingid
					};
					importSeatsData(condi);
					// queryAllSeatStatus(roomid, ruleid);
			    }
			})


       	$('.layui-ds').on('click', function() {
       		var type = $(this).data('type');
       		active[type] && active[type].call(this);
       	});
	});


	function importSeatsData(condi){
		$.ajax({
			async: true,
			type: "post",
			data: JSON.stringify(condi),
			contentType: 'application/json', 
			url: "https://m.longjuli.com/v1/meetings/sort",
			dataType: "json",
			success: function(obj) {
				console.log("--importSeatsData---",condi);
				if(obj && obj.attendees){
					changeSeatColor(obj.attendees);
				}
			},
			//失败的回调函数
			error: function() {
				console.log("error")
			}
		});
	}


	
	var seatcolors = ['#ffffff','#b3ffaf','#fffcb6','#ffb2b9','#91dfff'];
	var cli = 0;
	var gs = {};
	window.serverSeatIds = [];
	function changeSeatColor(attendees){
		if(attendees.length > 0){
			var ruleselect = $("#ruleselect").val() - 0;
			serverSeatIds = [];
			for(var i = 0,len = attendees.length; i < len; i++){
				// {"seatid":"1-1","attender":"028","id":"39"}
				var item = attendees[i] || {};
				if(ruleselect == 1){
					$("#" + item.seatid).css("background-color",item.bgcolor);
					$("#" + item.seatid).html(item.attender);

					serverSeatIds.push(item.seatid);
				}else{
					// var groupid = item.groupid+"";
					// var specialid = item.specialid+"";
					// var gsid = groupid;// + specialid;
					// if(gs[gsid]){
					// 	$("#" + item.seatid).css("background-color",gs[gsid]);
					// }else{
					// 	gs[gsid] = seatcolors[cli];
					// 	$("#" + item.seatid).css("background-color",seatcolors[cli]);
					// 	cli++;
					// 	if(cli==5){
					// 		cli=0;
					// 	}
					// }
				}
			}
		}
	}

	/**
	 * 打印局部div
	 * @param printpage 局部div的ID
	 */
	function printdiv(printpage) {
		var headhtml = "<html><head><title></title></head><body>";
		var foothtml = "</body>";
		// 获取div中的html内容
		// var newhtml = document.all.item(printpage).innerHTML;
		// 获取div中的html内容，jquery写法如下
		var newhtml= $("#" + printpage).html();

		// 获取原来的窗口界面body的html内容，并保存起来
		var oldhtml = document.body.innerHTML;

		// 给窗口界面重新赋值，赋自己拼接起来的html内容
		document.body.innerHTML = headhtml + newhtml + foothtml;
		// 调用window.print方法打印新窗口
		window.print();

		// 将原来窗口body的html值回填展示
		document.body.innerHTML = oldhtml;
		return false;
	}
	
	var $ = layui.$,
	active = {
		parallelism:function(){
			layer.open({
                type: 2,
                //title: '收藏管理 (考生姓名：张无忌)',
                title: '  ',
                shadeClose: false, //弹出框之外的地方是否可以点击
                area: ['100%', '106%'],
                closeBtn: 1,
                offset: '-43px',
                content: '../attender2rule/attender2rule.html',
                success: function(layero, index) {
                    // var body = layui.layer.getChildFrame('body', index);
                    // var roomid;
                    // // 取到弹出层里的元素，并把编辑的内容放进去
                    // body.find("#ruleid").val(data.id);
                    // body.find("#roomid").val(data.roomid); //将选中的数据的id传到编辑页面的隐藏域，便于根据ID修改数据
                }
            });
		},
		importData: function() {
			var condi = {
				"meeting_id": meetingid
			};
			importSeatsData(condi);
		},
		bindLockSeats:function(){
			bindLockSeats();
		},
		selectSeats:function(){
			selectSeats();
		},
		dragSeats:function(){
			dragSeats();
		},
		bindOneSeats:function(){
			bindOneSeats();
		},
		bindContextMenu:function(){
			bindContextMenu();
		},
		removeContextMenu:function(){
			removeContextMenu();
		},
		print:function(){
			console.log(11111);
			// printJS('seatcontainer', 'html');
			printdiv("seatcontainer");
		},
		close: function() {
			var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
	
			parent.layer.close(index); //再执行关闭 
			// parent.reloads()
		}
		// getCheckLength: function() { //获取选中数目
		// 	var checkStatus = table.checkStatus('test-table-operate'),
		// 		data = checkStatus.data;
		// 	layer.msg('选中了：' + data.length + ' 个');
		// },
		// isAll: function() { //验证是否全选
		// 	var checkStatus = table.checkStatus('test-table-operate');
		// 	layer.msg(checkStatus.isAll ? '全选' : '未全选')
		// },
		// add: function() {
		// 	layer.open({
		// 		type: 2,
		// 		title: '增加对应关系方案',
		// 		shadeClose: false, //弹出框之外的地方是否可以点击
		// 		offset: '10%',
		// 		area: ['60%', '80%'],
		// 		content: 'attender2rule_new.html',
		// 		btn: ['保存', '取消'],
		// 		yes: function(index, layero) {
		// 			var body = layer.getChildFrame('body', index);
		// 			var programmename = body.find('#programmename').val();
		// 			var select_meet = body.find('#select_meet').val();
		// 			var data = sessionStorage.getItem("attender2rule_data") || "";

		// 			var condi = {};
		// 			condi.attendee2rule = {
		// 				"name": programmename,
		// 				"meeting_id": +select_meet,
		// 				"rule_bindings": []
		// 			};
		// 			if(data){
		// 				var obj = JSON.parse(data);
		// 				// console.log("-----obj------",obj)
		// 				var rule_bindings = condi.attendee2rule.rule_bindings;
		// 				obj.forEach(function(item,index){
		// 					rule_bindings[index] = {};
		// 					rule_bindings[index].rulesetup_id = +item.id;
		// 					rule_bindings[index].sort_item = +item.sort_item;
		// 					rule_bindings[index].attribute_ids = item.treeCheckedIds;
							
		// 				});
		// 			}
		// 			console.log(condi);
					
		// 			saveAttendee2rules(condi,index);
		// 		}
		// 	});
		// },
		// reload:function() {
		// 	var key = $("#search-key").val();
		// 	getListData(key);
		// }
	};

	$('.layui-right-nav i').on('click', function() {
		var type = $(this).data('type');
		active[type] ? active[type].call(this) : '';
	});

	function asd() {
        location.reload();
    }
</script>

</html>